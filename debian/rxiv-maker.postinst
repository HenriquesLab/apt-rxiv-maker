#!/bin/bash
# postinst script for rxiv-maker
#
# pipx installation approach

set -e

WRAPPER_SCRIPT="/usr/bin/rxiv"
WRAPPER_INSTALL_DEPS="/usr/bin/rxiv-install-deps"

case "$1" in
    configure)
        echo "ðŸ”§ Setting up rxiv-maker with pipx..."
        
        # Ensure pipx is available and properly set up
        echo "ðŸ“¦ Setting up pipx environment..."
        
        # Run pipx ensurepath to set up PATH (non-interactively)
        export PIPX_HOME="/opt/pipx"
        export PIPX_BIN_DIR="/usr/local/bin"
        
        # Create pipx directories if they don't exist
        mkdir -p "$PIPX_HOME" "$PIPX_BIN_DIR"
        
        # Install rxiv-maker using pipx directly from GitHub
        echo "ðŸš€ Installing rxiv-maker via pipx..."
        if PIPX_HOME="$PIPX_HOME" PIPX_BIN_DIR="$PIPX_BIN_DIR" pipx install --force git+https://github.com/henriqueslab/rxiv-maker.git; then
            echo "âœ… rxiv-maker installed successfully via pipx"
        else
            echo "âŒ Failed to install rxiv-maker via pipx"
            exit 1
        fi
        
        # Create wrapper scripts to ensure proper PATH
        echo "ðŸ”— Creating wrapper scripts..."
        
        # Main rxiv command wrapper
        cat > "$WRAPPER_SCRIPT" << 'EOF'
#!/bin/bash
# Wrapper script for rxiv-maker installed via pipx

export PIPX_HOME="/opt/pipx"
export PIPX_BIN_DIR="/usr/local/bin"

# Check if rxiv is available via pipx
if [ -x "$PIPX_BIN_DIR/rxiv" ]; then
    exec "$PIPX_BIN_DIR/rxiv" "$@"
elif command -v rxiv >/dev/null 2>&1; then
    exec rxiv "$@"
else
    echo "âŒ rxiv-maker not found. Try reinstalling: sudo apt reinstall rxiv-maker"
    exit 1
fi
EOF
        chmod +x "$WRAPPER_SCRIPT"
        
        # Dependency installer wrapper
        cat > "$WRAPPER_INSTALL_DEPS" << 'EOF'
#!/bin/bash
# Wrapper script for rxiv-install-deps installed via pipx

export PIPX_HOME="/opt/pipx"
export PIPX_BIN_DIR="/usr/local/bin"

# Check if rxiv-install-deps is available via pipx
if [ -x "$PIPX_BIN_DIR/rxiv-install-deps" ]; then
    exec "$PIPX_BIN_DIR/rxiv-install-deps" "$@"
elif command -v rxiv-install-deps >/dev/null 2>&1; then
    exec rxiv-install-deps "$@"
else
    echo "âŒ rxiv-install-deps not found. Try reinstalling: sudo apt reinstall rxiv-maker"
    exit 1
fi
EOF
        chmod +x "$WRAPPER_INSTALL_DEPS"
        
        # Set proper ownership and permissions
        chown -R root:root "/opt/pipx" 2>/dev/null || true
        chmod -R 755 "/opt/pipx" 2>/dev/null || true
        
        # Update TeX file database if texlive is installed
        if command -v mktexlsr >/dev/null 2>&1; then
            echo "ðŸ“š Updating TeX file database..."
            mktexlsr /usr/share/texmf 2>/dev/null || true
        fi
        
        # Verify installation
        if [ -x "$WRAPPER_SCRIPT" ] && command -v pipx >/dev/null 2>&1; then
            echo "âœ… rxiv-maker installed successfully!"
            echo "   ðŸ“ Installation method: pipx"
            echo "   ðŸ  pipx home: $PIPX_HOME"
            echo "   ðŸ”— Commands: rxiv, rxiv-install-deps"
            echo ""
            echo "   Run 'rxiv --help' to get started"
            echo "   All Python dependencies isolated with pipx"
        else
            echo "âŒ Installation failed - missing components"
            exit 1
        fi
    ;;

    abort-upgrade|abort-remove|abort-deconfigure)
    ;;

    *)
        echo "postinst called with unknown argument \`$1'" >&2
        exit 1
    ;;
esac

# dh_installdeb will replace this with shell code automatically
# generated by other debhelper scripts.

#DEBHELPER#

exit 0

#!/bin/bash
# postinst script for rxiv-maker
#
# Virtual environment installation approach

set -e

INSTALL_DIR="/opt/rxiv-maker"
VENV_DIR="$INSTALL_DIR/venv"
REPO_DIR="$INSTALL_DIR/repo" 
WRAPPER_SCRIPT="/usr/bin/rxiv"
WRAPPER_INSTALL_DEPS="/usr/bin/rxiv-install-deps"

case "$1" in
    configure)
        echo "ðŸ”§ Setting up rxiv-maker virtual environment..."
        
        # Create installation directory
        mkdir -p "$INSTALL_DIR"
        
        # Install uv (fast Python package installer)
        echo "ðŸ“¦ Installing uv package manager..."
        if ! command -v uv >/dev/null 2>&1; then
            if curl -LsSf https://astral.sh/uv/install.sh | sh; then
                export PATH="$HOME/.cargo/bin:$PATH"
                echo "âœ… uv installed successfully"
            else
                echo "âš ï¸  uv installation failed, will use pip as fallback"
            fi
        else
            echo "âœ… uv already available"
        fi
        
        # Clone the actual rxiv-maker repository
        echo "ðŸ“¥ Cloning rxiv-maker repository..."
        if [ -d "$REPO_DIR" ]; then
            cd "$REPO_DIR"
            git pull --quiet origin main || echo "âš ï¸  Failed to update repository"
        else
            git clone --quiet https://github.com/henriqueslab/rxiv-maker.git "$REPO_DIR" || {
                echo "âŒ Failed to clone repository"
                exit 1
            }
        fi
        
        # Create virtual environment with Python 3.10+
        echo "ðŸ Creating Python virtual environment..."
        if python3 -m venv "$VENV_DIR" --without-pip; then
            echo "âœ… Virtual environment created without pip bootstrap"
        elif python3 -m venv "$VENV_DIR"; then
            echo "âœ… Virtual environment created with system pip"
        else
            echo "âŒ Failed to create virtual environment"
            exit 1
        fi
        
        # Ensure pip is available in virtual environment
        echo "ðŸ”§ Setting up pip in virtual environment..."
        if ! "$VENV_DIR/bin/python" -m pip --version >/dev/null 2>&1; then
            echo "ðŸ“¦ Installing pip manually..."
            # Download get-pip.py as fallback for restricted environments
            if command -v curl >/dev/null 2>&1; then
                curl -s https://bootstrap.pypa.io/get-pip.py -o /tmp/get-pip.py
                "$VENV_DIR/bin/python" /tmp/get-pip.py
                rm -f /tmp/get-pip.py
            elif command -v wget >/dev/null 2>&1; then
                wget -q https://bootstrap.pypa.io/get-pip.py -O /tmp/get-pip.py
                "$VENV_DIR/bin/python" /tmp/get-pip.py
                rm -f /tmp/get-pip.py
            else
                echo "âŒ Cannot download pip installer"
                exit 1
            fi
        fi
        
        # Install dependencies using uv in virtual environment
        echo "ðŸ“¦ Installing Python dependencies..."
        cd "$REPO_DIR"
        if command -v uv >/dev/null 2>&1; then
            echo "ðŸš€ Using uv for fast installation..."
            if "$VENV_DIR/bin/python" -m pip install uv >/dev/null 2>&1; then
                if "$VENV_DIR/bin/uv" pip install -e . >/dev/null 2>&1; then
                    echo "âœ… Dependencies installed successfully with uv"
                else
                    echo "âš ï¸  uv installation failed, falling back to pip..."
                    "$VENV_DIR/bin/pip" install --upgrade pip >/dev/null 2>&1
                    "$VENV_DIR/bin/pip" install -e .
                fi
            else
                echo "âš ï¸  uv setup failed, using pip..."
                "$VENV_DIR/bin/pip" install --upgrade pip >/dev/null 2>&1
                "$VENV_DIR/bin/pip" install -e .
            fi
        else
            echo "ðŸ Using pip for installation..."
            "$VENV_DIR/bin/pip" install --upgrade pip >/dev/null 2>&1
            "$VENV_DIR/bin/pip" install -e .
        fi
        
        # Create wrapper script for rxiv command
        echo "ðŸ”— Creating wrapper script..."
        cat > "$WRAPPER_SCRIPT" << 'EOF'
#!/bin/bash
# Wrapper script for rxiv-maker

INSTALL_DIR="/opt/rxiv-maker"
VENV_DIR="$INSTALL_DIR/venv"

# Check if virtual environment exists
if [ ! -d "$VENV_DIR" ]; then
    echo "âŒ rxiv-maker virtual environment not found at $VENV_DIR"
    echo "   Try reinstalling the package: sudo apt reinstall rxiv-maker"
    exit 1
fi

# Activate virtual environment and run rxiv
exec "$VENV_DIR/bin/python" "$VENV_DIR/bin/rxiv" "$@"
EOF
        chmod +x "$WRAPPER_SCRIPT"
        
        # Create wrapper script for dependency installer
        cat > "$WRAPPER_INSTALL_DEPS" << 'EOF'
#!/bin/bash
# Wrapper script for rxiv-install-deps

INSTALL_DIR="/opt/rxiv-maker"
VENV_DIR="$INSTALL_DIR/venv"

# Check if virtual environment exists
if [ ! -d "$VENV_DIR" ]; then
    echo "âŒ rxiv-maker virtual environment not found at $VENV_DIR"
    echo "   Try reinstalling the package: sudo apt reinstall rxiv-maker"
    exit 1
fi

# Activate virtual environment and run rxiv-install-deps
exec "$VENV_DIR/bin/python" "$VENV_DIR/bin/rxiv-install-deps" "$@"
EOF
        chmod +x "$WRAPPER_INSTALL_DEPS"
        
        # Set proper ownership and permissions
        chown -R root:root "$INSTALL_DIR"
        chmod -R 755 "$INSTALL_DIR"
        
        # Update TeX file database if texlive is installed
        if command -v mktexlsr >/dev/null 2>&1; then
            echo "ðŸ“š Updating TeX file database..."
            mktexlsr /usr/share/texmf 2>/dev/null || true
        fi
        
        # Verify installation
        if [ -x "$WRAPPER_SCRIPT" ] && [ -d "$VENV_DIR" ]; then
            echo "âœ… rxiv-maker installed successfully!"
            echo "   ðŸ“ Installation directory: $INSTALL_DIR"
            echo "   ðŸ Virtual environment: $VENV_DIR"
            echo "   ðŸ”— Command: rxiv (wrapper script)"
            echo ""
            echo "   Run 'rxiv --help' to get started"
            echo "   All Python dependencies isolated in virtual environment"
        else
            echo "âŒ Installation failed - missing components"
            exit 1
        fi
    ;;

    abort-upgrade|abort-remove|abort-deconfigure)
    ;;

    *)
        echo "postinst called with unknown argument \`$1'" >&2
        exit 1
    ;;
esac

# dh_installdeb will replace this with shell code automatically
# generated by other debhelper scripts.

#DEBHELPER#

exit 0

#!/bin/bash
# postinst script for rxiv-maker
#
# PyInstaller binary distribution approach

set -e

INSTALL_DIR="/opt/rxiv-maker"
BIN_DIR="/usr/local/bin"

case "$1" in
    configure)
        echo "🔧 Setting up rxiv-maker using PyInstaller binaries..."
        
        # Create installation directory
        mkdir -p "$INSTALL_DIR" "$BIN_DIR"
        
        echo "📦 Installing pre-built rxiv-maker binaries..."
        
        # Copy the pre-built PyInstaller binaries from the package
        # The binaries are included in the Debian package under /usr/share/rxiv-maker/binaries/
        PACKAGE_BINARIES="/usr/share/rxiv-maker/binaries"
        
        if [ -f "$PACKAGE_BINARIES/rxiv" ] && [ -f "$PACKAGE_BINARIES/rxiv-install-deps" ]; then
            echo "✅ Found PyInstaller binaries in package"
            
            # Copy binaries to installation directory
            cp "$PACKAGE_BINARIES/rxiv" "$INSTALL_DIR/rxiv"
            cp "$PACKAGE_BINARIES/rxiv-install-deps" "$INSTALL_DIR/rxiv-install-deps"
            
            # Make sure they're executable
            chmod +x "$INSTALL_DIR/rxiv"
            chmod +x "$INSTALL_DIR/rxiv-install-deps"
            
            echo "📋 Binary information:"
            ls -la "$INSTALL_DIR/"
            
        else
            echo "❌ PyInstaller binaries not found in package at $PACKAGE_BINARIES"
            echo "Expected files:"
            echo "  - $PACKAGE_BINARIES/rxiv"
            echo "  - $PACKAGE_BINARIES/rxiv-install-deps"
            exit 1
        fi
        
        # Create symlinks in system PATH
        echo "🔗 Creating system links..."
        ln -sf "$INSTALL_DIR/rxiv" "$BIN_DIR/rxiv"
        ln -sf "$INSTALL_DIR/rxiv-install-deps" "$BIN_DIR/rxiv-install-deps"
        
        # Also create convenience symlinks in /usr/bin for compatibility
        ln -sf "$BIN_DIR/rxiv" "/usr/bin/rxiv"
        ln -sf "$BIN_DIR/rxiv-install-deps" "/usr/bin/rxiv-install-deps"
        
        # Set proper ownership and permissions
        chown -R root:root "$INSTALL_DIR" 2>/dev/null || true
        chmod -R 755 "$INSTALL_DIR" 2>/dev/null || true
        
        # Update TeX file database if texlive is installed
        if command -v mktexlsr >/dev/null 2>&1; then
            echo "📚 Updating TeX file database..."
            mktexlsr /usr/share/texmf 2>/dev/null || true
        fi
        
        # Test the binaries to ensure they work
        echo "🧪 Testing installed binaries..."
        if "$INSTALL_DIR/rxiv" --version >/dev/null 2>&1; then
            echo "✅ rxiv binary works correctly"
        else
            echo "⚠️ rxiv binary test failed (might be normal if --version not implemented)"
        fi
        
        if "$INSTALL_DIR/rxiv-install-deps" --help >/dev/null 2>&1; then
            echo "✅ rxiv-install-deps binary works correctly"
        else
            echo "⚠️ rxiv-install-deps binary test failed (might be normal)"
        fi
        
        # Verify installation
        if [ -x "/usr/bin/rxiv" ] && [ -x "$INSTALL_DIR/rxiv" ]; then
            echo ""
            echo "🎉 rxiv-maker installed successfully!"
            echo "   📍 Installation method: PyInstaller standalone binaries"
            echo "   🏠 Installation directory: $INSTALL_DIR"
            echo "   🔗 Commands: rxiv, rxiv-install-deps"
            echo "   📦 Binary sizes:"
            echo "      $(ls -lh "$INSTALL_DIR/rxiv" | awk '{print "rxiv: " $5}')"
            echo "      $(ls -lh "$INSTALL_DIR/rxiv-install-deps" | awk '{print "rxiv-install-deps: " $5}')"
            echo ""
            echo "   🚀 Ready to use - no dependencies need to be installed!"
            echo "   Run 'rxiv --help' to get started"
        else
            echo "❌ Installation failed - missing components"
            exit 1
        fi
    ;;

    abort-upgrade|abort-remove|abort-deconfigure)
    ;;

    *)
        echo "postinst called with unknown argument \`$1'" >&2
        exit 1
    ;;
esac

# dh_installdeb will replace this with shell code automatically
# generated by other debhelper scripts.

#DEBHELPER#

exit 0